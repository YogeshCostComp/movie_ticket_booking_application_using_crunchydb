<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üé¨ CineBook ‚Äî Movie Ticket Booking</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg-primary: #0f0f1a;
      --bg-secondary: #1a1a2e;
      --bg-card: #16213e;
      --accent: #e94560;
      --accent-hover: #ff6b81;
      --success: #00b894;
      --warning: #fdcb6e;
      --text-primary: #ffffff;
      --text-secondary: #a0a0b8;
      --border: #2a2a4a;
      --seat-available: #e94560;
      --seat-selected: #00b894;
      --seat-blocked: #4a4a6a;
      --shadow: 0 8px 32px rgba(0,0,0,0.4);
      --radius: 12px;
    }
    html { font-size: 16px; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* ===== Header ===== */
    .header {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      padding: 20px 0;
      border-bottom: 1px solid var(--border);
      position: sticky; top: 0; z-index: 100;
      backdrop-filter: blur(10px);
    }
    .header-inner {
      max-width: 1200px; margin: 0 auto; padding: 0 24px;
      display: flex; align-items: center; justify-content: space-between;
    }
    .logo { display: flex; align-items: center; gap: 12px; }
    .logo-icon { font-size: 32px; }
    .logo h1 {
      font-family: 'Poppins', sans-serif;
      font-size: 24px; font-weight: 800;
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .header-actions { display: flex; gap: 10px; }
    .btn-header {
      padding: 10px 20px; border-radius: 8px; border: none;
      font-size: 14px; font-weight: 600; cursor: pointer;
      transition: all 0.3s ease; font-family: 'Inter', sans-serif;
    }
    .btn-view-bookings {
      background: rgba(0,184,148,0.15); color: var(--success);
      border: 1px solid rgba(0,184,148,0.3);
    }
    .btn-view-bookings:hover { background: rgba(0,184,148,0.3); transform: translateY(-1px); }
    .btn-reset {
      background: rgba(233,69,96,0.15); color: var(--accent);
      border: 1px solid rgba(233,69,96,0.3);
    }
    .btn-reset:hover { background: rgba(233,69,96,0.3); transform: translateY(-1px); }

    /* ===== Main Layout ===== */
    .main-container {
      max-width: 1200px; margin: 0 auto; padding: 32px 24px;
      display: grid; grid-template-columns: 1fr 380px; gap: 32px;
    }

    /* ===== Movie Info ===== */
    .movie-info {
      background: var(--bg-card); border-radius: var(--radius);
      padding: 24px; margin-bottom: 24px; border: 1px solid var(--border);
    }
    .movie-info h2 {
      font-family: 'Poppins', sans-serif; font-size: 22px; font-weight: 700;
      margin-bottom: 6px;
    }
    .movie-meta { display: flex; gap: 16px; flex-wrap: wrap; }
    .movie-meta span {
      font-size: 13px; color: var(--text-secondary);
      display: flex; align-items: center; gap: 4px;
    }

    /* ===== Screen ===== */
    .screen-area { text-align: center; margin-bottom: 24px; }
    .screen-label {
      font-size: 12px; text-transform: uppercase; letter-spacing: 3px;
      color: var(--text-secondary); margin-bottom: 8px;
    }
    .screen-display {
      width: 80%; max-width: 500px; height: 8px; margin: 0 auto;
      background: linear-gradient(180deg, rgba(233,69,96,0.6), transparent);
      border-radius: 50% 50% 0 0; border-top: 3px solid var(--accent);
    }

    /* ===== Legend ===== */
    .legend {
      display: flex; justify-content: center; gap: 24px; margin: 20px 0;
    }
    .legend-item { display: flex; align-items: center; gap: 6px; font-size: 13px; color: var(--text-secondary); }
    .legend-dot { width: 16px; height: 16px; border-radius: 4px; }
    .legend-dot.available { background: var(--seat-available); }
    .legend-dot.selected { background: var(--seat-selected); }
    .legend-dot.blocked { background: var(--seat-blocked); }

    /* ===== Seat Grid ===== */
    .seating-area {
      background: var(--bg-card); border-radius: var(--radius);
      padding: 24px; border: 1px solid var(--border);
    }
    .seat-row {
      display: flex; justify-content: center; align-items: center;
      margin-bottom: 6px; gap: 0;
    }
    .row-label {
      width: 28px; font-size: 13px; font-weight: 600;
      color: var(--text-secondary); text-align: center; flex-shrink: 0;
    }
    .seat-group { display: flex; gap: 6px; }
    .seat-group.left { margin-right: 20px; }
    .seat-group.right { margin-left: 20px; }
    .seat { position: relative; width: 38px; height: 34px; }
    .seat input[type="checkbox"] {
      position: absolute; opacity: 0; width: 100%; height: 100%;
      cursor: pointer; z-index: 2;
    }
    .seat label {
      display: flex; align-items: center; justify-content: center;
      width: 100%; height: 100%;
      background: var(--seat-available);
      border-radius: 6px 6px 2px 2px;
      font-size: 10px; font-weight: 600; color: white;
      cursor: pointer; transition: all 0.2s ease;
      position: relative;
    }
    .seat label::after {
      content: ''; position: absolute; bottom: -3px;
      left: 3px; right: 3px; height: 3px;
      background: inherit; border-radius: 0 0 3px 3px;
      filter: brightness(0.7);
    }
    .seat input:checked + label {
      background: var(--seat-selected);
      transform: scale(1.08);
      box-shadow: 0 0 12px rgba(0,184,148,0.5);
    }
    .seat input:disabled + label {
      background: var(--seat-blocked);
      cursor: not-allowed; opacity: 0.6;
    }
    .seat label:hover { filter: brightness(1.2); }
    .seat input:disabled + label:hover { filter: none; }

    /* ===== Right Panel ===== */
    .booking-panel { position: sticky; top: 100px; height: fit-content; }
    .panel-card {
      background: var(--bg-card); border-radius: var(--radius);
      padding: 28px; border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }
    .panel-card h3 {
      font-family: 'Poppins', sans-serif; font-size: 18px;
      margin-bottom: 20px; color: var(--text-primary);
    }
    .stats-row {
      display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
      margin-bottom: 24px;
    }
    .stat-box {
      background: rgba(255,255,255,0.03); border: 1px solid var(--border);
      border-radius: 8px; padding: 14px; text-align: center;
    }
    .stat-value { font-size: 24px; font-weight: 700; font-family: 'Poppins', sans-serif; }
    .stat-value.available { color: var(--accent); }
    .stat-value.booked-val { color: var(--seat-blocked); }
    .stat-value.selected { color: var(--success); }
    .stat-label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; margin-top: 4px; }

    /* ===== Form ===== */
    .form-group { margin-bottom: 16px; }
    .form-group label {
      display: block; font-size: 13px; font-weight: 500;
      color: var(--text-secondary); margin-bottom: 6px;
    }
    .form-input {
      width: 100%; padding: 12px 16px; border-radius: 8px;
      border: 1px solid var(--border); background: var(--bg-secondary);
      color: var(--text-primary); font-size: 14px;
      font-family: 'Inter', sans-serif; transition: border 0.3s ease;
      outline: none;
    }
    .form-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(233,69,96,0.15); }
    .form-input::placeholder { color: var(--text-secondary); opacity: 0.6; }

    .btn-reserve {
      width: 100%; padding: 14px; border: none; border-radius: 8px;
      background: linear-gradient(135deg, var(--accent), #c0392b);
      color: white; font-size: 16px; font-weight: 700;
      font-family: 'Poppins', sans-serif; cursor: pointer;
      transition: all 0.3s ease; letter-spacing: 0.5px; margin-top: 8px;
    }
    .btn-reserve:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(233,69,96,0.4); }
    .btn-reserve:active { transform: translateY(0); }
    .btn-reserve:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    .selected-seats {
      background: rgba(0,184,148,0.08); border: 1px solid rgba(0,184,148,0.2);
      border-radius: 8px; padding: 12px; margin-bottom: 16px; min-height: 42px;
    }
    .selected-seats-label {
      font-size: 12px; color: var(--text-secondary); text-transform: uppercase;
      letter-spacing: 1px; margin-bottom: 6px;
    }
    .selected-seats-list { font-size: 14px; font-weight: 600; color: var(--success); }

    /* ===== Modal ===== */
    .modal-overlay {
      display: none; position: fixed; top: 0; left: 0;
      width: 100%; height: 100%; background: rgba(0,0,0,0.7);
      z-index: 1000; align-items: center; justify-content: center;
      backdrop-filter: blur(4px);
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: var(--bg-card); border-radius: 16px;
      padding: 32px; width: 90%; max-width: 700px; max-height: 80vh;
      overflow-y: auto; border: 1px solid var(--border);
      box-shadow: 0 24px 64px rgba(0,0,0,0.5);
      animation: modalSlideIn 0.3s ease;
    }
    @keyframes modalSlideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .modal-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border);
    }
    .modal-header h2 { font-family: 'Poppins', sans-serif; font-size: 20px; }
    .modal-close {
      width: 36px; height: 36px; border-radius: 8px; border: none;
      background: rgba(255,255,255,0.05); color: var(--text-secondary);
      font-size: 20px; cursor: pointer; transition: all 0.2s;
    }
    .modal-close:hover { background: rgba(233,69,96,0.2); color: var(--accent); }
    .booking-table { width: 100%; border-collapse: collapse; font-size: 14px; }
    .booking-table th {
      background: rgba(233,69,96,0.1); color: var(--accent);
      padding: 12px 16px; text-align: left; font-weight: 600;
      font-size: 12px; text-transform: uppercase; letter-spacing: 1px;
    }
    .booking-table td {
      padding: 12px 16px; border-bottom: 1px solid var(--border);
      color: var(--text-primary);
    }
    .booking-table tr:hover td { background: rgba(255,255,255,0.02); }
    .no-bookings { text-align: center; padding: 40px 20px; color: var(--text-secondary); }
    .no-bookings-icon { font-size: 48px; margin-bottom: 12px; }

    /* ===== Toast ===== */
    .toast {
      position: fixed; top: 24px; right: 24px; padding: 16px 24px;
      border-radius: 12px; font-size: 14px; font-weight: 500;
      z-index: 9999; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      display: flex; align-items: center; gap: 10px;
      transform: translateX(120%); transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
      max-width: 400px;
    }
    .toast.show { transform: translateX(0); }
    .toast.success { background: linear-gradient(135deg, #00b894, #00a381); color: white; }
    .toast.error { background: linear-gradient(135deg, #e94560, #c0392b); color: white; }
    .toast.warning { background: linear-gradient(135deg, #f39c12, #e67e22); color: white; }

    /* ===== SRE Panel ===== */
    .sre-panel {
      background: var(--bg-card); border-radius: var(--radius);
      padding: 20px; border: 1px solid var(--border); margin-top: 16px;
    }
    .sre-panel h4 {
      font-size: 14px; color: var(--accent); margin-bottom: 12px;
      display: flex; align-items: center; gap: 8px;
    }
    .sre-select {
      width: 100%; padding: 10px 12px; border-radius: 8px;
      border: 1px solid var(--border); background: var(--bg-secondary);
      color: var(--text-primary); font-size: 13px; margin-bottom: 10px;
      font-family: 'Inter', sans-serif; outline: none;
    }
    .btn-sre {
      width: 100%; padding: 10px; border-radius: 8px; border: none;
      background: rgba(233,69,96,0.15); color: var(--accent);
      font-size: 13px; font-weight: 600; cursor: pointer;
      font-family: 'Inter', sans-serif; transition: all 0.2s;
    }
    .btn-sre:hover { background: rgba(233,69,96,0.3); }
    .sre-result {
      margin-top: 10px; font-size: 13px; border-radius: 8px;
      padding: 10px; display: none;
    }

    /* ===== Confirm Modal ===== */
    .confirm-overlay {
      display: none; position: fixed; top: 0; left: 0;
      width: 100%; height: 100%; background: rgba(0,0,0,0.7);
      z-index: 2000; align-items: center; justify-content: center;
      backdrop-filter: blur(4px);
    }
    .confirm-overlay.active { display: flex; }
    .confirm-box {
      background: var(--bg-card); border-radius: 16px; padding: 32px;
      width: 90%; max-width: 420px; text-align: center;
      border: 1px solid var(--border); box-shadow: 0 24px 64px rgba(0,0,0,0.5);
    }
    .confirm-box h3 { font-family: 'Poppins', sans-serif; margin-bottom: 12px; }
    .confirm-box p { color: var(--text-secondary); font-size: 14px; margin-bottom: 24px; }
    .confirm-actions { display: flex; gap: 12px; justify-content: center; }
    .btn-confirm-yes {
      padding: 10px 28px; border-radius: 8px; border: none;
      background: var(--accent); color: white;
      font-weight: 600; cursor: pointer; font-family: 'Inter', sans-serif;
    }
    .btn-confirm-no {
      padding: 10px 28px; border-radius: 8px;
      border: 1px solid var(--border); background: transparent;
      color: var(--text-secondary); font-weight: 600; cursor: pointer;
      font-family: 'Inter', sans-serif;
    }

    /* ===== Responsive ===== */
    @media (max-width: 900px) {
      .main-container { grid-template-columns: 1fr; }
      .booking-panel { position: relative; top: 0; }
      .header-inner { flex-direction: column; gap: 12px; }
      .header-actions { width: 100%; justify-content: center; }
    }
    @media (max-width: 600px) {
      .seat { width: 30px; height: 28px; }
      .seat label { font-size: 8px; }
      .seat-group { gap: 4px; }
      .seat-group.left { margin-right: 12px; }
      .seat-group.right { margin-left: 12px; }
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="header">
    <div class="header-inner">
      <div class="logo">
        <span class="logo-icon">üé¨</span>
        <h1>CineBook</h1>
      </div>
      <div class="header-actions">
        <button class="btn-header btn-view-bookings" onclick="openBookingsModal()">üìã View Bookings</button>
        <button class="btn-header btn-reset" onclick="confirmReset()">üîÑ Reset Bookings</button>
        <a href="/chat" target="_blank" class="btn-header btn-agent" style="background:linear-gradient(135deg,#6c5ce7,#a29bfe);color:#fff;text-decoration:none;display:inline-flex;align-items:center;gap:6px;">ü§ñ SRE Agent</a>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <div class="main-container">
    <!-- Left: Seat Selection -->
    <div class="left-panel">
      <div class="movie-info">
        <h2>üé• Mini Screen 1</h2>
        <div class="movie-meta">
          <span>üïê Show: 7:00 PM</span>
          <span>üìÖ Today</span>
          <span>üí∫ 60 Seats</span>
        </div>
      </div>

      <div class="seating-area">
        <div class="screen-area">
          <div class="screen-label">Screen</div>
          <div class="screen-display"></div>
        </div>

        <div class="legend">
          <div class="legend-item"><div class="legend-dot available"></div> Available</div>
          <div class="legend-item"><div class="legend-dot selected"></div> Selected</div>
          <div class="legend-item"><div class="legend-dot blocked"></div> Booked</div>
        </div>

        <div id="seat-grid"></div>
      </div>
    </div>

    <!-- Right: Booking Panel -->
    <div class="booking-panel">
      <div class="panel-card">
        <h3>üé´ Book Your Seats</h3>
        <div class="stats-row">
          <div class="stat-box">
            <div class="stat-value available" id="stat-available">60</div>
            <div class="stat-label">Available</div>
          </div>
          <div class="stat-box">
            <div class="stat-value selected" id="stat-selected">0</div>
            <div class="stat-label">Selected</div>
          </div>
        </div>

        <div class="selected-seats">
          <div class="selected-seats-label">Selected Seats</div>
          <div class="selected-seats-list" id="selected-list">None</div>
        </div>

        <div class="form-group">
          <label for="name">Full Name</label>
          <input type="text" id="name" class="form-input" placeholder="Enter your name" required>
        </div>
        <div class="form-group">
          <label for="phone">Phone Number</label>
          <input type="number" id="phone" class="form-input" placeholder="Enter phone number" required>
        </div>

        <button class="btn-reserve" id="btn-reserve" onclick="reserve_seats()">
          üé¨ Reserve Seats
        </button>
      </div>

      <!-- SRE Panel -->
      <div class="sre-panel">
        <h4>üõ†Ô∏è SRE Error Simulator</h4>
        <select id="errorType" class="sre-select">
          <option value="all">üî• All Errors</option>
          <option value="500">500 ‚Äî Internal Server Error</option>
          <option value="404">404 ‚Äî Not Found</option>
          <option value="503">503 ‚Äî Service Unavailable</option>
          <option value="db_error">Database Connection Error</option>
          <option value="timeout">Request Timeout (504)</option>
          <option value="exception">Unhandled Exception</option>
        </select>
        <button class="btn-sre" onclick="simulateError()">‚ö° Generate Error</button>
        <div id="error-result" class="sre-result"></div>
      </div>
    </div>
  </div>

  <!-- Bookings Modal -->
  <div class="modal-overlay" id="bookings-modal">
    <div class="modal">
      <div class="modal-header">
        <h2>üìã All Bookings</h2>
        <button class="modal-close" onclick="closeBookingsModal()">‚úï</button>
      </div>
      <div id="bookings-body">
        <div class="no-bookings">
          <div class="no-bookings-icon">üîÑ</div>
          <p>Loading bookings...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Reset Confirm Modal -->
  <div class="confirm-overlay" id="reset-confirm">
    <div class="confirm-box">
      <h3>‚ö†Ô∏è Reset All Bookings?</h3>
      <p>This will clear all reservations and reset every seat to available. This action cannot be undone.</p>
      <div class="confirm-actions">
        <button class="btn-confirm-yes" onclick="doReset()">Yes, Reset</button>
        <button class="btn-confirm-no" onclick="closeConfirm()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

<script>
// ===== Session Trace ID (carried automatically via cookie) =====
var SESSION_TRACE_ID = '{{ trace_id }}';
console.log('Session Trace ID:', SESSION_TRACE_ID);

// ===== Seat Data =====
var data_seats = {};
var rows = [1,2,3,4,5,6,7,8,9,10];
var cols = ['A','B','C','D','E','F'];
rows.forEach(function(r) {
  cols.forEach(function(c) { data_seats[r + c] = 'available'; });
});

// ===== Generate Seat Grid =====
function buildSeatGrid() {
  var grid = document.getElementById('seat-grid');
  grid.innerHTML = '';
  rows.forEach(function(r) {
    var row = document.createElement('div');
    row.className = 'seat-row';

    var label = document.createElement('div');
    label.className = 'row-label';
    label.textContent = r;
    row.appendChild(label);

    var leftGroup = document.createElement('div');
    leftGroup.className = 'seat-group left';
    var rightGroup = document.createElement('div');
    rightGroup.className = 'seat-group right';

    cols.forEach(function(c, idx) {
      var seatId = r + c;
      var seat = document.createElement('div');
      seat.className = 'seat';
      var input = document.createElement('input');
      input.type = 'checkbox';
      input.id = seatId;
      input.onclick = function() { myFunction(seatId); };
      var lbl = document.createElement('label');
      lbl.setAttribute('for', seatId);
      lbl.textContent = seatId;
      seat.appendChild(input);
      seat.appendChild(lbl);
      if (idx < 3) leftGroup.appendChild(seat);
      else rightGroup.appendChild(seat);
    });

    row.appendChild(leftGroup);
    row.appendChild(rightGroup);

    var labelR = document.createElement('div');
    labelR.className = 'row-label';
    labelR.textContent = r;
    row.appendChild(labelR);

    grid.appendChild(row);
  });
}

// ===== Load seat status from DB =====
function data_all() {
  $.get("/get?trace_id=" + SESSION_TRACE_ID).done(function(data) {
    var obj = typeof data === 'string' ? JSON.parse(data) : data;
    var avail = 0, blocked = 0;
    for (var x in obj) {
      data_seats[x] = obj[x];
      var el = document.getElementById(x);
      if (!el) continue;
      if (obj[x] === "blocked") {
        el.disabled = true;
        blocked++;
      } else {
        el.disabled = false;
        avail++;
      }
    }
    document.getElementById('stat-available').textContent = avail;
    updateSelectedDisplay();
  });
}

function myFunction(z) {
  var cb = document.getElementById(z);
  data_seats[z] = cb.checked ? "reserved" : "available";
  updateSelectedDisplay();
}

function updateSelectedDisplay() {
  var selected = [];
  for (var k in data_seats) {
    if (data_seats[k] === "reserved") selected.push(k);
  }
  selected.sort();
  document.getElementById('stat-selected').textContent = selected.length;
  document.getElementById('selected-list').textContent = selected.length ? selected.join(', ') : 'None';
}

// ===== Reserve Seats =====
function reserve_seats() {
  var nameVal = document.getElementById("name").value.trim();
  var phoneVal = document.getElementById("phone").value.trim();

  if (!nameVal) { showToast("Please enter your name.", "error"); return; }
  if (!phoneVal || phoneVal.length < 7) { showToast("Please enter a valid phone number (min 7 digits).", "error"); return; }

  var hasSelection = false;
  for (var k in data_seats) { if (data_seats[k] === "reserved") { hasSelection = true; break; } }
  if (!hasSelection) { showToast("Please select at least one seat.", "error"); return; }

  var userdetails = { name: nameVal, number: phoneVal };
  var formData = new FormData();
  formData.append("userdetails", JSON.stringify(userdetails));
  formData.append("data_seats", JSON.stringify(data_seats));
  formData.append("trace_id", SESSION_TRACE_ID);

  var btn = document.getElementById('btn-reserve');
  btn.disabled = true;
  btn.textContent = '‚è≥ Reserving...';

  $.ajax({
    url: '/update', type: 'POST', data: formData,
    dataType: 'json', cache: false, contentType: false, processData: false,
    success: function(response) {
      if (response.flag == 0) {
        showToast(response.message || "Seats reserved successfully!", "success");
        setTimeout(function() { location.replace("/details?trace_id=" + SESSION_TRACE_ID); }, 1500);
      } else {
        showToast(response.error || "Reservation failed.", "error");
        btn.disabled = false; btn.textContent = 'üé¨ Reserve Seats';
      }
    },
    error: function(xhr) {
      var msg = "Something went wrong.";
      try { var r = JSON.parse(xhr.responseText); if (r.error) msg = r.error; } catch(e) {}
      showToast(msg, "error");
      btn.disabled = false; btn.textContent = 'üé¨ Reserve Seats';
    }
  });
}

// ===== View Bookings Modal =====
function openBookingsModal() {
  document.getElementById('bookings-modal').classList.add('active');
  document.getElementById('bookings-body').innerHTML =
    '<div class="no-bookings"><div class="no-bookings-icon">üîÑ</div><p>Loading...</p></div>';

  $.get("/getUsersDetails?trace_id=" + SESSION_TRACE_ID).done(function(data) {
    var bookings = typeof data === 'string' ? JSON.parse(data) : data;
    if (!bookings || bookings.length === 0) {
      document.getElementById('bookings-body').innerHTML =
        '<div class="no-bookings"><div class="no-bookings-icon">üé´</div><p>No bookings yet.</p></div>';
      return;
    }
    var html = '<table class="booking-table"><thead><tr><th>#</th><th>Name</th><th>Phone</th><th>Seats</th></tr></thead><tbody>';
    bookings.forEach(function(b, i) {
      html += '<tr><td>' + (i+1) + '</td><td>' + b.name + '</td><td>' + b.phone_no + '</td><td>' + b.seats + '</td></tr>';
    });
    html += '</tbody></table>';
    document.getElementById('bookings-body').innerHTML = html;
  }).fail(function() {
    document.getElementById('bookings-body').innerHTML =
      '<div class="no-bookings"><div class="no-bookings-icon">‚ùå</div><p>Failed to load bookings.</p></div>';
  });
}
function closeBookingsModal() { document.getElementById('bookings-modal').classList.remove('active'); }

// ===== Reset Bookings =====
function confirmReset() { document.getElementById('reset-confirm').classList.add('active'); }
function closeConfirm() { document.getElementById('reset-confirm').classList.remove('active'); }
function doReset() {
  closeConfirm();
  $.ajax({
    url: '/resetBookings?trace_id=' + SESSION_TRACE_ID, type: 'POST',
    success: function(data) {
      var resp = typeof data === 'string' ? JSON.parse(data) : data;
      showToast(resp.message || "Bookings reset successfully!", "success");
      setTimeout(function() { location.reload(); }, 1200);
    },
    error: function() { showToast("Failed to reset bookings.", "error"); }
  });
}

// ===== Toast =====
function showToast(msg, type) {
  var toast = document.getElementById('toast');
  toast.className = 'toast ' + (type || 'success');
  var icon = type === 'error' ? '‚ö†Ô∏è' : (type === 'warning' ? '‚ö°' : '‚úÖ');
  toast.innerHTML = icon + ' ' + msg;
  toast.classList.add('show');
  clearTimeout(window._toastTimer);
  window._toastTimer = setTimeout(function() { toast.classList.remove('show'); }, 5000);
}

// ===== SRE Error Simulator =====
function simulateError() {
  var errorType = document.getElementById('errorType').value;
  var result = document.getElementById('error-result');
  result.style.display = 'block';
  result.style.background = 'rgba(253,203,110,0.1)';
  result.style.color = '#fdcb6e';
  result.innerHTML = '‚è≥ Generating error...';
  $.ajax({
    url: '/simulate/error?trace_id=' + SESSION_TRACE_ID, type: 'POST', contentType: 'application/json',
    data: JSON.stringify({error_type: errorType}),
    complete: function(xhr) {
      var resp;
      try { resp = JSON.parse(xhr.responseText); } catch(e) { resp = {}; }
      var code = xhr.status;
      var bg = code >= 500 ? 'rgba(233,69,96,0.15)' : 'rgba(253,203,110,0.15)';
      var color = code >= 500 ? '#e94560' : '#fdcb6e';
      result.style.background = bg;
      result.style.color = color;
      result.innerHTML = '<strong>HTTP ' + code + '</strong> ‚Äî ' + (resp.message || resp.error || 'Error generated');
    }
  });
}

// ===== Init =====
window.onload = function() { buildSeatGrid(); data_all(); };

// Close modals on overlay click
document.addEventListener('click', function(e) {
  if (e.target.id === 'bookings-modal') closeBookingsModal();
  if (e.target.id === 'reset-confirm') closeConfirm();
});
</script>
</body>
</html>
